<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.momo.mapper.SaleMapper">
    <select id="isDuplicatedTel" parameterType="com.momo.common.vo.SaleVO">
        select IF(count(*) > 0, true, false)
        from tb_sale
        where shop_id=#{shopId} and
              cust_tel=#{custTel} and
              MONTH(actv_dt) = MONTH(#{actvDt}) and
              YEAR(actv_dt) = YEAR(#{actvDt})
    </select>

    <select id="fetchSupportSale" parameterType="com.momo.common.vo.SaleVO">
        select s.*,
                sp.sup_div,
                sp.sup_amount,
                sp.sup_st
        from tb_sale_support sp
        left outer join tb_sale s on s.sale_id=sp.sale_id
        where s.shop_id=#{shopId} and
        <if test="saleId != null and !saleId.equals('')">
            s.sale_id=#{saleId} and
        </if>
        <if test="keyword != null and !keyword.equals('')">
            (
            s.cust_nm like '%${keyword}%' or
            s.cust_tel like '%${keyword}%' or
            s.cust_gtel like '%${keyword}%' or
            s.cust_cd like '%${keyword}%'
            ) and
        </if>
        <if test="sellerId != null and !sellerId.equals('')">
            s.seller_id=#{sellerId} and
        </if>
        1=1
        <if test="order != null and !order.equals('')">
            order by ${order} ${asc}
        </if>
        <if test="limit != null and !limit.equals('')">
            limit ${limit} ${offset}
        </if>
    </select>

    <select id="fetchCombSale" parameterType="com.momo.common.vo.SaleVO">
        select s.*,
                scb.comb_id,
                scb.comb_order_tp,
                scb.comb_st,
                scb.comb_doc
        from tb_sale_comb scb
        left outer join tb_sale s on s.sale_id=scb.sale_id
        where s.shop_id=#{shopId} and
        <if test="saleId != null and !saleId.equals('')">
            s.sale_id=#{saleId} and
        </if>
        <if test="keyword != null and !keyword.equals('')">
            (
            s.cust_nm like '%${keyword}%' or
            s.cust_tel like '%${keyword}%' or
            s.cust_gtel like '%${keyword}%' or
            s.cust_cd like '%${keyword}%'
            ) and
        </if>
        <if test="sellerId != null and !sellerId.equals('')">
            s.seller_id=#{sellerId} and
        </if>
        1=1
        <if test="order != null and !order.equals('')">
            order by ${order} ${asc}
        </if>
        <if test="limit != null and !limit.equals('')">
            limit ${limit} ${offset}
        </if>
    </select>

    <select id="fetchGreenPhoneSale" parameterType="com.momo.common.vo.SaleVO">
        select s.*,
                sg.ph_md,
                sg.green_st,
        from tb_sale_green sg
        left outer join tb_sale s on s.sale_id=sg.sale_id
        where s.shop_id=#{shopId} and
        <if test="saleId != null and !saleId.equals('')">
            s.sale_id=#{saleId} and
        </if>
        <if test="keyword != null and !keyword.equals('')">
            (
            s.cust_nm like '%${keyword}%' or
            s.cust_tel like '%${keyword}%' or
            s.cust_gtel like '%${keyword}%' or
            s.cust_cd like '%${keyword}%'
            ) and
        </if>
        <if test="sellerId != null and !sellerId.equals('')">
            s.seller_id=#{sellerId} and
        </if>
        1=1
        <if test="order != null and !order.equals('')">
            order by ${order} ${asc}
        </if>
        <if test="limit != null and !limit.equals('')">
            limit ${limit} ${offset}
        </if>
    </select>

    <select id="fetchCardSale" parameterType="com.momo.common.vo.SaleVO">
        select s.*,
               sc.card_id,
               sc.card_tp,
               sc.card_st
        from tb_sale_card sc
        left outer join tb_sale s on s.sale_id=sc.sale_id
        where s.shop_id=#{shopId} and
        <if test="saleId != null and !saleId.equals('')">
            s.sale_id=#{saleId} and
        </if>
        <if test="keyword != null and !keyword.equals('')">
            (
            s.cust_nm like '%${keyword}%' or
            s.cust_tel like '%${keyword}%' or
            s.cust_gtel like '%${keyword}%' or
            s.cust_cd like '%${keyword}%'
            ) and
        </if>
        <if test="sellerId != null and !sellerId.equals('')">
            s.seller_id=#{sellerId} and
        </if>
        1=1
        <if test="order != null and !order.equals('')">
            order by ${order} ${asc}
        </if>
        <if test="limit != null and !limit.equals('')">
            limit ${limit} ${offset}
        </if>
    </select>

    <select id="fetchSale" parameterType="com.momo.common.vo.SaleVO">
        select *
        from tb_sale s
        where shop_id=#{shopId} and
        <if test="saleId != null and !saleId.equals('')">
            s.sale_id=#{saleId} and
        </if>
        <if test="keyword != null and !keyword.equals('')">
            (
                s.cust_nm like '%${keyword}%' or
                s.cust_tel like '%${keyword}%' or
                s.cust_gtel like '%${keyword}%' or
                s.cust_cd like '%${keyword}%'
            ) and
        </if>
        <if test="sellerId != null and !sellerId.equals('')">
            s.seller_id=#{sellerId} and
        </if>
        1=1
        <if test="order != null and !order.equals('')">
            order by ${order} ${asc}
        </if>
        <if test="limit != null and !limit.equals('')">
            limit ${limit} ${offset}
        </if>
    </select>

    <update id="updateSale" parameterType="com.momo.common.vo.SaleVO">
        update tb_sale
        set cust_nm = #{custNm},
            cust_tel = #{custTel},
            cust_gtel = #{custGtel},
            cust_cd = #{custCd},
            cust_gd = #{custGd},
            provider = #{provider},
            ph_md = #{phMd},
            ct_istm = #{ctIstm},
            ct_actv_div = #{ctActvDiv},
            ct_actv_tp = #{ctActvTp},
            ct_actv_plan = #{ctActvPlan},
            ct_dec_plan = #{ctDecPlan},
            ct_cms = #{ctCms},
            sec_md = #{secMd},
            wt_actv_tp = #{wtActvTp},
            wt_actv_div = #{wtActvDiv},
            wt_cms = #{wtCms},
            inet_actv_plan = #{inetActvPlan},
            inet_dec_plan = #{inetDecPlan},
            tv_actv_plan = #{tvActvPlan},
            tv_dec_plan = #{tvDecPlan},
            exsvc_id = #{exsvcId},
            seller_id = #{sellerId},
            spec = #{spec},
            sale_docs = #{saleDocs},
            sale_memo = #{saleMemo}
        where sale_id=#{saleId}
        and shop_id=#{shopId}
    </update>

    <delete id="deleteSale">
        delete from tb_sale
        where sale_id=#{saleId}
        and shop_id=#{shopId}
    </delete>

    <insert id="insertSale" parameterType="com.momo.common.vo.SaleVO">
        set @shopId := (
            select shop_id
            from tb_emp
            where emp_id= #{userId}
            );

        insert into tb_sale
        (shop_id, sale_id, cust_nm, cust_tel, cust_gtel, cust_cd, cust_gd,
         provider, ph_md, ct_istm, ct_actv_div, ct_actv_tp, ct_actv_plan,
         ct_dec_plan, ct_cms, sec_md, wt_actv_tp, wt_actv_div, wt_cms,
         inet_actv_plan, inet_dec_plan, tv_actv_plan, tv_dec_plan, exsvc_id,
         seller_id, spec, sale_docs, sale_memo)
        values (@shopId,(
                select *
                from (
                         select IFNULL(max(sale_id), 0)+1
                         from    tb_sale
                         where   shop_id=@shopId
                     ) as sub_sale
            ), #{custNm},#{custTel},#{custGtel},#{custCd},#{custGd},
                #{provider},#{phMd},#{ctIstm},#{ctActvDiv},#{ctActvTp},#{ctActvPlan},
                #{ctDecPlan},#{ctCms},#{secMd},#{wtActvTp},#{wtActvDiv},#{wtCms},
                #{inetActvPlan},#{inetDecPlan},#{tvActvPlan},#{tvDecPlan},#{exsvcId}
               ,#{sellerId},#{spec},#{saleDocs},#{saleMemo})
    </insert>

</mapper>