<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.momo.mapper.ReserveMsgMapper">
    <insert id="insertMsg" parameterType="com.momo.common.vo.ReserveMessageVO">
        SET @curr_shop_id := (
            select curr_shop_id
            from tb_account
            where id=#{userId}
            );

        SET @next_msg_id := (
            select IFNULL(max(msg_id),0)+1
            from tb_rsv_msg
            where shop_id=@curr_shop_id and
                  sale_id=#{saleId}
            );

        INSERT INTO tb_rsv_msg
        (shop_id, sale_id, msg_id, msg_tp, content, rsv_dt, rsv_tp, dday)
        VALUES (@curr_shop_id, #{saleId}, @next_msg_id, #{msgTp},#{content},#{rsvDt}, #{rsvTp}, #{dday})
    </insert>

    <select id="getReserveMsgForCalendar">
        SELECT rsv_dt,
               msg_st,
               COUNT(msg_tp) as cnt
        FROM tb_rsv_msg
        WHERE shop_id=(
            SELECT curr_shop_id
            FROM tb_account
            WHERE id=#{userId}
            ) and
            rsv_dt like '%${date}%'
        GROUP BY rsv_dt, msg_st
    </select>

    <select id="getReserveMsgDetail">
        SELECT sl.cust_nm,
               msg_tp,
               IF(rm.rsv_tp != 2, 'D', 'M') as dday_tp,
               dday
        FROM tb_rsv_msg rm
        LEFT OUTER JOIN tb_sale sl on sl.sale_id= rm.sale_id
        WHERE rm.shop_id=(
                            SELECT curr_shop_id
                            FROM tb_account
                            WHERE id=#{userId}
                        ) and
            rsv_dt=#{date} and
            msg_st=#{state}
    </select>
</mapper>