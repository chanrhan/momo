<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.momo.mapper.ShopMapper">
    <!--    Shop-->
    <insert id="insertShop" parameterType="com.momo.common.vo.UserVO">
        SET @corpId := (
                           SELECT corp_id
                           FROM tb_emp
                           WHERE emp_id=#{userId}
                       );

        SET @lastShopId := (
            SELECT max(shop_id)
            FROM tb_shop
            WHERE corp_id=@corpId
            );

        INSERT INTO tb_shop
            (shop_id, corp_id, shop_nm, shop_addr, shop_tel)
        VALUES (@lastShopId + 1, @corpId, #{shopNm}, #{shopAddr}, #{shopTel})
    </insert>

    <update id="updateShop" parameterType="com.momo.common.vo.UserVO">
        update
        tb_shop
        set
        <if test='shopNm != null and !shopNm.equals("")'>
            shop_nm=#{shopNm},
        </if>
        <if test='corpId != null'>
            corp_id=#{corpId},
        </if>
        <if test='shopTel != null and !shopTel.equals("")'>
            shop_tel=#{shopTel},
        </if>
        <if test='sendTel != null and !sendTel.equals("")'>
            send_tel=#{sendTel},
        </if>
        <if test='shopAddr != null and !shopAddr.equals("")'>
            shop_addr=#{shopAddr},
        </if>
        shop_id=#{shopId}
        where
        shop_id=#{shopId}
    </update>

    <delete id="deleteShop">
        DELETE
        FROM tb_shop
        WHERE shop_id = #{id}
    </delete>

    <select id="getShop" parameterType="com.momo.common.vo.ShopVO">
        with tb as (
            select
            sh.*,
            cp.corp_bp_no,
            ac.name as reps_nm
            from
            tb_shop sh
            left outer join tb_corp cp on cp.corp_id=sh.corp_id
            left outer join tb_account ac on ac.id=cp.reps_id
        )

        select
        *
        from
        tb
        where corp_id=(
            select tb_emp.corp_id
            from    tb_emp
            where emp_id=#{userId}
        ) and
        <if test='keyword != null and !keyword.equals("")'>
            (
                shop_nm like '%${keyword}%' or
                reps_nm like '%${keyword}%'
            ) and
        </if>
        1 = 1
        <if test='order != null and !order.equals("")'>
            order by
            ${order} ${asc}
        </if>
<!--        <if test='limit != null and offset != null'>-->
<!--            limit ${offset} ${limit}-->
<!--        </if>-->
    </select>

    <!--    Corperation-->
    <insert id="insertCorp" parameterType="com.momo.common.vo.ShopVO">
        INSERT INTO tb_corp
        (corp_id, reps_id, corp_bp_no, bp_ko_nm, bp_en_nm, corp_nm, corp_tel, start_dt)
        VALUES (#{corpId}, #{repsId}, #{corpBpNo}, #{bpKoNm}, #{bpEnNm}, #{corpNm}, #{corpTel}, #{startDt})
    </insert>

    <update id="updateCorp" parameterType="com.momo.common.vo.ShopVO">
        update
        tb_corp
        set
        <if test='corpBpNo != null and !corpBpNo.equals("")'>
            corp_bp_no=#{corpBpNo},
        </if>
        <if test='bpKoNm != null and !bpKoNm.equals("")'>
            bp_ko_nm=#{bpKoNm},
        </if>

        <if test='bpEnNm != null and !bpEnNm.equals("")'>
            bp_en_nm=#{bpEnNm},
        </if>

        <if test='corpNm != null and !corpNm.equals("")'>
            corp_nm=#{corpNm},
        </if>

        <if test='corpTel != null and !corpTel.equals("")'>
            corp_tel=#{corpTel},
        </if>

        <if test='startDt != null and !startDt.equals("")'>
            start_dt=#{startDt},
        </if>
        reps_id=#{repsId}
        where
        corp_id=#{corpId}
    </update>

    <update id="updateCorpPoint">
        UPDATE
            tb_corp
        SET corp_pt=corp_pt + (#{amount})
        WHERE corp_id = #{id}
    </update>

    <delete id="deleteCorp">
        DELETE
        FROM tb_corp
        WHERE corp_id = #{id}
    </delete>

    <select id="getMaxCorpId">
        SELECT MAX(corp_id)
        FROM tb_corp
            FOR
        UPDATE
    </select>

    <select id="getCorporation" parameterType="com.momo.common.vo.ShopVO">
        SELECT *
        FROM tb_corp
        WHERE
        <if test="keyword != null and !keyword.equals('')">
            (
            corp_nm LIKE '%${keyword}%' OR
            corp_id LIKE '%${keyword}%'
            ) and
        </if>
        1=1
        <if test="order != null and !order.equals('')">
            order by ${order} ${asc}
        </if>
    </select>



</mapper>