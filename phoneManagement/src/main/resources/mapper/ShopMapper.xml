<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.momo.mapper.ShopMapper">
    <!--    Shop-->
    <insert id="insertShop" parameterType="com.momo.common.vo.UserVO">
        INSERT INTO tb_shop
            (shop_id, corp_id, shop_nm, shop_addr, shop_tel)
        VALUES (#{shopId}, (
            SELECT corp_id
            FROM tb_emp
            WHERE emp_id=#{userId}
        ), #{shopNm}, #{shopAddr}, #{shopTel})
    </insert>

    <update id="updateShop" parameterType="com.momo.common.vo.UserVO">
        update
        tb_shop
        set
        <if test='shopNm != null and !shopNm.equals("")'>
            shop_nm=#{shopNm},
        </if>
        <if test='corpId != null'>
            corp_id=#{corpId},
        </if>
        <if test='shopTel != null and !shopTel.equals("")'>
            shop_tel=#{shopTel},
        </if>
        <if test='sendTel != null and !sendTel.equals("")'>
            send_tel=#{sendTel},
        </if>
        <if test='shopAddr != null and !shopAddr.equals("")'>
            shop_addr=#{shopAddr},
        </if>
        shop_id=#{shopId}
        where
        shop_id=#{shopId}
    </update>

    <delete id="deleteShop">
        DELETE
        FROM tb_shop
        WHERE shop_id = #{shopId}
    </delete>

    <select id="getShop" parameterType="com.momo.common.vo.ShopVO">
        with tb as (
            select
            sh.*,
            cp.bp_no,
            ac.name as reps_nm
            from
            tb_shop sh
            left outer join tb_corp cp on cp.corp_id=sh.corp_id
            left outer join tb_account ac on ac.id=cp.reps_id
        )

        select
        *
        from
        tb
        where
        <if test="userId != null and !userId.equals('')">
            corp_id=(
            select tb_emp.corp_id
            from    tb_emp
            where emp_id=#{userId}
            ) and
        </if>
        <if test='keyword != null and !keyword.equals("")'>
            (
                shop_nm like '%${keyword}%' or
                shop_cd like '%${keyword}%'
            ) and
        </if>
        1 = 1
        <if test='order != null and !order.equals("")'>
            order by
            ${order} ${asc}
        </if>
<!--        <if test='limit != null and offset != null'>-->
<!--            limit ${offset} ${limit}-->
<!--        </if>-->
    </select>

    <!--    Corperation-->
    <insert id="insertCorp" parameterType="com.momo.common.vo.ShopVO">
        INSERT INTO tb_corp
        (corp_id, bp_no, corp_nm)
        values ((
            select *
            from    (
                select IFNULL(max(corp_id),0)+1
                from tb_corp
                    ) as sub
            ), #{bpNo},#{corpNm})
    </insert>

    <update id="updateCorp" parameterType="com.momo.common.vo.ShopVO">
        update
        tb_corp
        set
        bp_no=#{bpNo},
        corp_nm=#{corpNm}
        where
        corp_id=#{corpId}
    </update>

    <update id="updateCorpPoint">
        UPDATE
            tb_corp
        SET corp_pt=corp_pt + (#{amount})
        WHERE corp_id = #{id}
    </update>

    <delete id="deleteCorp">
        DELETE
        FROM tb_corp
        WHERE corp_id = #{id}
    </delete>


    <select id="getCorp" parameterType="com.momo.common.vo.ShopVO">
        SELECT *
        FROM tb_corp
        WHERE
        <if test="keyword != null and !keyword.equals('')">
            (
            corp_nm LIKE '%${keyword}%'
            ) and
        </if>
        1=1
        <if test="order != null and !order.equals('')">
            order by ${order} ${asc}
        </if>
    </select>



</mapper>